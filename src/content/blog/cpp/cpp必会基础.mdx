---
title: C++必会基础
publishDate: 2022-03-27
description: 'C++必会基础'
tags:
  - C++
---
import { Aside, Steps } from 'astro-pure/user'
import {Dot} from 'src/user'

## 1. 基础语法

### 1.1. sizeof

- 指针大小永远固定。取决于编译的目标平台的位数。32 位就是 4 字节，64 位就是 8 字节。
- 数组作为函数参数时会退化为指针，大小按指针计算。
- struct 结构体要考虑字节对齐。
- 如果 class 配置了虚函数，则会在头部添加虚函数表。
- 空类会用 1 个字节进行占位。
- 字符串数组要加上末尾的 `\0`。

### 1.2. 数组退化为指针

数组退化：在 C++ 中，数组在作为函数参数时会退化为指向其首元素的指针。

退化的原因是因为数组作为函数参数时，**实际传递的是指向数组首元素的指针**，不可能逐个拷贝整个数组然后在栈上传递，所以编译器只知道参数是一个指针，而不知道它的长度信息。

但是，当数组直接作为 `sizeof` 的参数时，它不会退化，因为 sizeof 是编译器在编译期间计算的结果，这个时候编译器是有信息知道数组的大小。

为了在函数中获取数组的长度，需要将数组的长度作为另一个参数传递给函数，或者使用模板实现。

### 1.3. const

只需要记住 **const 是优先左匹配的**。

**修饰指针或引用**：
```cpp
const int* p = &a;
int const* p = &a;
int* const p = &a;
const int* const p = &a;

const int& a = 1;
int& const a = 1; // x，const cant apply to reference
```

**修饰函数**：
```cpp
const int f() {}
```

**修饰成员函数**：
```cpp
int f() const {}\
```

### 1.4. static

#### 1.4.1. 修饰全局变量

static修饰全局变量可以将变量的作用域限定在当前文件。其他文件无法获取到该符号。
static全局变量在程序启动时被初始化，生命周期和程序一样长。

#### 1.4.2. 修饰局部变量

static修饰局部变量，会改变变量的存储位置，从栈区变为静态区。
static局部变量在程序启动时被初始化，生命周期和程序一样长。

#### 1.4.3. 修饰局部变量

static 修饰局部变量可以使得变量在函数调用结束后不会被销毁，而是一直存在于内存中，下次调用该函数时可以继续使用。同时，由于 static 修饰的局部变量的作用域仅限于函数内部，所以其他函数无法访问该变量。

#### 1.4.4. 修饰成员变量和函数

static 修饰类成员变量和函数可以使得它们在所有类对象中共享，且不需要创建对象就可以直接访问。

### 1.5. volatile

volatile是 C 语言中的一个关键字，用于修饰变量，表示该变量的值可能在任何时候被外部因素更改，例如硬件设备、操作系统或其他线程。当一个变量被声明为volatile时，编译器会禁止对该变量进行优化，以确保每次访问变量时都会从内存中读取其值，而不是从寄存器或缓存中读取。避免因为编译器优化而导致出现不符合预期的结果。

**注意**：volatile并不能保证线程安全。

### 1.6. 字节对齐

#### 1.6.1. 为什么需要字节对齐

字节对齐有助于提高内存访问速度，因为许多处理器都优化了对齐数据的访问。但是，这可能会导致内存中的一些空间浪费。

**为什么设置字节对齐能提高存取速度**

答：主要是因为现代计算机都使用了Cache。
    Cache可以看成一些可以用非常快的速度进行访问的临时内存。但是Cache的容量不大，比如一般一级Cache只有几K到几十K,二级Cache只有几百K到几M.这个同数G的内存相比，是比较小的。
    但是CPU访问内存非常慢，所以硬件会将平时经常使用的内容存放到Cache里面。Cache是通过一些Cache Line来组织的，每一条Cache Line一般包含16个字节，32个字节或64个字节等。 比如某个计算机一级Cache的Cache Line长度是32个字节，那么每段Cache Line总是会包含32个字节对齐的一段内存。
   现在有一个4字节的整数，如果它的地址不是4字节对齐的，那么就有可能访问它的时候，需要使用两条Cache Line,这增加了总线通讯量，而且增加了对Cache的使用量，而且使用的数据没有在Cache里面（这时需要将数据从内存调入Cache,会非常慢）的机会会增加，这些都降低了程序的速度。

#### 1.6.2. 字节对齐的规则

**结构体对齐**：
- 按照基础类型的最大公约数对齐

**联合体对齐**：
- 取最大成员进行对齐

**编译器指令**：
- `#pragma pack(n)`：设置结构体的对齐方式为 n 字节对齐

**对齐属性**：
- `alignas(n)`：设置结构体的对齐方式为 n 字节对齐
